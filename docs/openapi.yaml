openapi: 3.0.3
info:
  title: Meta Chat Platform API
  description: |
    Multi-tenant conversational AI platform with LLM integration, RAG retrieval, and multi-channel support.

    ## Authentication

    The API uses two types of API keys:
    - **Tenant API Keys** (`x-api-key` header): Used for tenant-specific operations (channels, documents, conversations, webhooks)
    - **Admin API Keys** (`x-admin-key` header): Used for platform administration (tenant management, API key management)

    ## Rate Limiting

    Default rate limits: 120 requests per minute per IP address.
    Rate limit headers are included in responses:
    - `X-RateLimit-Limit`: Maximum requests per window
    - `X-RateLimit-Remaining`: Remaining requests in current window
    - `X-RateLimit-Reset`: Time when the rate limit resets
  version: 1.0.0
  contact:
    name: API Support
    email: support@metachat.example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.metachat.example.com
    description: Production server
  - url: http://localhost:3000
    description: Local development server

tags:
  - name: Tenants
    description: Tenant management (admin access)
  - name: Channels
    description: Communication channel management
  - name: Documents
    description: Knowledge base document management
  - name: Conversations
    description: Conversation and message management
  - name: Webhooks
    description: Outgoing webhook configuration
  - name: Security
    description: API key management
  - name: Health
    description: Health and metrics endpoints

components:
  securitySchemes:
    TenantApiKey:
      type: apiKey
      in: header
      name: x-api-key
      description: Tenant API key for accessing tenant-specific resources
    AdminApiKey:
      type: apiKey
      in: header
      name: x-admin-key
      description: Admin API key for platform administration

  schemas:
    Tenant:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        slug:
          type: string
        active:
          type: boolean
        settings:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Channel:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        type:
          type: string
          enum: [whatsapp, messenger, webchat]
        name:
          type: string
        config:
          type: object
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Document:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        name:
          type: string
        source:
          type: string
        status:
          type: string
          enum: [pending, processing, indexed, failed]
        metadata:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        channelId:
          type: string
          format: uuid
        userId:
          type: string
        status:
          type: string
          enum: [active, closed, escalated]
        metadata:
          type: object
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'

    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        direction:
          type: string
          enum: [inbound, outbound]
        content:
          type: string
        metadata:
          type: object
        timestamp:
          type: string
          format: date-time

    Webhook:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenantId:
          type: string
          format: uuid
        url:
          type: string
          format: uri
        events:
          type: array
          items:
            type: string
        headers:
          type: object
        active:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    HealthCheck:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        services:
          type: object
          properties:
            database:
              type: string
              enum: [up, down]
            redis:
              type: string
              enum: [up, down]
            rabbitmq:
              type: string
              enum: [up, down]
        timestamp:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      description: Check the health status of the API and its dependencies
      responses:
        '200':
          description: Health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheck'

  /metrics:
    get:
      tags: [Health]
      summary: Prometheus metrics
      description: Get Prometheus-format metrics for monitoring
      responses:
        '200':
          description: Metrics in Prometheus format
          content:
            text/plain:
              schema:
                type: string

  /api/tenants:
    get:
      tags: [Tenants]
      summary: List all tenants
      description: Get a list of all tenants (admin access required)
      security:
        - AdminApiKey: []
      parameters:
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter by active status
      responses:
        '200':
          description: List of tenants
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [Tenants]
      summary: Create a new tenant
      description: Create a new tenant and generate an API key
      security:
        - AdminApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, slug]
              properties:
                name:
                  type: string
                slug:
                  type: string
                  pattern: '^[a-z0-9-]+$'
                settings:
                  type: object
      responses:
        '201':
          description: Tenant created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      tenant:
                        $ref: '#/components/schemas/Tenant'
                      apiKey:
                        type: string
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/tenants/{tenantId}:
    get:
      tags: [Tenants]
      summary: Get a specific tenant
      security:
        - AdminApiKey: []
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Tenant details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Tenant'
        '404':
          description: Tenant not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Tenants]
      summary: Update a tenant
      security:
        - AdminApiKey: []
      parameters:
        - name: tenantId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                active:
                  type: boolean
                settings:
                  type: object
      responses:
        '200':
          description: Tenant updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Tenant'

  /api/channels:
    get:
      tags: [Channels]
      summary: List channels
      description: Get all channels for the authenticated tenant
      security:
        - TenantApiKey: []
      parameters:
        - name: type
          in: query
          schema:
            type: string
            enum: [whatsapp, messenger, webchat]
        - name: active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of channels
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Channel'

    post:
      tags: [Channels]
      summary: Create a channel
      security:
        - TenantApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, name, config]
              properties:
                type:
                  type: string
                  enum: [whatsapp, messenger, webchat]
                name:
                  type: string
                config:
                  type: object
      responses:
        '201':
          description: Channel created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Channel'

  /api/channels/{channelId}:
    put:
      tags: [Channels]
      summary: Update a channel
      security:
        - TenantApiKey: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                config:
                  type: object
                active:
                  type: boolean
      responses:
        '200':
          description: Channel updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Channel'

    delete:
      tags: [Channels]
      summary: Delete a channel
      security:
        - TenantApiKey: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Channel deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  /api/documents:
    get:
      tags: [Documents]
      summary: List documents
      security:
        - TenantApiKey: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, processing, indexed, failed]
      responses:
        '200':
          description: List of documents
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Document'

    post:
      tags: [Documents]
      summary: Create a document
      security:
        - TenantApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, source]
              properties:
                name:
                  type: string
                source:
                  type: string
                metadata:
                  type: object
      responses:
        '201':
          description: Document created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Document'

  /api/documents/{documentId}:
    get:
      tags: [Documents]
      summary: Get a document
      security:
        - TenantApiKey: []
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Document details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Document'

    put:
      tags: [Documents]
      summary: Update a document
      security:
        - TenantApiKey: []
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                status:
                  type: string
                  enum: [pending, processing, indexed, failed]
                metadata:
                  type: object
      responses:
        '200':
          description: Document updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Document'

    delete:
      tags: [Documents]
      summary: Delete a document
      security:
        - TenantApiKey: []
      parameters:
        - name: documentId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Document deleted

  /api/conversations:
    get:
      tags: [Conversations]
      summary: List conversations
      security:
        - TenantApiKey: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [active, closed, escalated]
        - name: channelId
          in: query
          schema:
            type: string
            format: uuid
        - name: userId
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Conversation'

    post:
      tags: [Conversations]
      summary: Create a conversation
      security:
        - TenantApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [channelId, userId]
              properties:
                channelId:
                  type: string
                  format: uuid
                userId:
                  type: string
                metadata:
                  type: object
      responses:
        '201':
          description: Conversation created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Conversation'

  /api/conversations/{conversationId}:
    get:
      tags: [Conversations]
      summary: Get a conversation with messages
      security:
        - TenantApiKey: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation with messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Conversation'

    put:
      tags: [Conversations]
      summary: Update a conversation
      security:
        - TenantApiKey: []
      parameters:
        - name: conversationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [active, closed, escalated]
                metadata:
                  type: object
      responses:
        '200':
          description: Conversation updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Conversation'

  /api/webhooks:
    get:
      tags: [Webhooks]
      summary: List webhooks
      security:
        - TenantApiKey: []
      parameters:
        - name: active
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Webhook'

    post:
      tags: [Webhooks]
      summary: Create a webhook
      security:
        - TenantApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url, events]
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  items:
                    type: string
                  minItems: 1
                secret:
                  type: string
                headers:
                  type: object
      responses:
        '201':
          description: Webhook created
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Webhook'

  /api/webhooks/{webhookId}:
    get:
      tags: [Webhooks]
      summary: Get a webhook
      security:
        - TenantApiKey: []
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook details
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Webhook'

    put:
      tags: [Webhooks]
      summary: Update a webhook
      security:
        - TenantApiKey: []
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                events:
                  type: array
                  items:
                    type: string
                headers:
                  type: object
                active:
                  type: boolean
      responses:
        '200':
          description: Webhook updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    $ref: '#/components/schemas/Webhook'

    delete:
      tags: [Webhooks]
      summary: Delete a webhook
      security:
        - TenantApiKey: []
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Webhook deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
